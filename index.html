<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storigami - Origami Macera Oyunu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        secondary: '#EC4899',
                        accent: '#10B981',
                        warning: '#F59E0B',
                        surface: '#F8FAFC',
                        'surface-dark': '#E2E8F0',
                        // Storigami Harmony Palette
                        'stori-mint': '#A8E6CF', // Mint ye≈üili
                        'stori-orange': '#FFAB91', // Turuncu
                        'stori-lila': '#ADD8E6', // Lila
                        'stori-sky': '#CCEEFF', // G√∂ky√ºz√º mavisi
                        'stori-text': '#3D352E', // Koyu gri metin rengi
                        'stori-bg': '#FDFBF5', // A√ßƒ±k krem arka plan
                    },
                    fontFamily: {
                        'display': ['Inter', 'system-ui', 'sans-serif'],
                        'body': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Storigami Harmony (Mint, Orange, Lila, Sky) with standard Tailwind gradients for primary/secondary/accent. -->
    <!-- Application Structure Plan: A single-page application starting with a Welcome Screen that integrates age selection for streamlined onboarding. After age selection, the user proceeds to a main Game Screen (adventure hub) where they can choose various LLM-powered adventure modules (Paper Forest for animal facts, Story Castle for AI stories, Creativity Island for AI naming). Each adventure module has its own dedicated detail screen with specific interactive elements. -->
    <!-- Visualization & Content Choices: Welcome Screen -> Goal: Engage, Onboard, Get Age -> Viz: Hero with title, embedded age selector with iconic buttons -> Interaction: Select age, then click "Maceraya Ba≈üla" to proceed -> Justification: Direct, child-friendly onboarding. | Game Screen (Hub) -> Goal: Present adventure options & player stats -> Viz: Player profile, progress bar, clickable adventure cards with icons/descriptions -> Interaction: Click cards to enter specific adventures, hover for audio descriptions -> Justification: Centralized navigation, gamified experience. | AdventureDetailForest (new) -> Goal: Provide interactive animal facts -> Viz: Animal icons, text output for facts -> Interaction: Click animal icon for AI-generated fact + TTS -> Justification: Engaging, informative, leverages LLM for dynamic content. | AdventureDetailCastle (re-integrated AI Story) -> Goal: Create AI stories from user origami -> Viz: File upload area, image preview, text story output, audio player -> Interaction: Upload photo, trigger AI analysis (simulated), play story -> Justification: Creative outlet, multi-modal output. | AdventureDetailIsland (re-integrated AI Naming) -> Goal: Generate creative names for origami -> Viz: Text input, button, list output -> Interaction: Enter description, trigger AI name generation -> Justification: Enhances creativity, simple text-based interaction. CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: theme('colors.stori-bg');
            color: theme('colors.stori-text');
            overflow-x: hidden;
        }
        
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, theme('colors.primary') 0%, theme('colors.purple.500') 100%);
        }
        
        .gradient-secondary {
            background: linear-gradient(135deg, theme('colors.secondary') 0%, theme('colors.orange.500') 100%);
        }
        
        .gradient-accent {
            background: linear-gradient(135deg, theme('colors.accent') 0%, theme('colors.green.700') 100%);
        }
        
        .icon-bounce {
            animation: iconBounce 2s ease-in-out infinite;
        }
        
        @keyframes iconBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .card-modern {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid theme('colors.surface-dark');
            cursor: pointer;
        }
        
        .card-modern:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, theme('colors.primary') 0%, theme('colors.purple.500') 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 16px 24px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, theme('colors.primary') 0%, theme('colors.purple.600') 100%);
        }
        
        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:active::after {
            width: 300px;
            height: 300px;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, theme('colors.secondary') 0%, theme('colors.orange.500') 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 16px 24px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(236, 72, 153, 0.4);
            background: linear-gradient(135deg, theme('colors.secondary') 0%, theme('colors.orange.600') 100%);
        }
        
        .floating-voice {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 50;
        }
        
        .pulse-ring {
            animation: pulseRing 2s infinite;
        }
        
        @keyframes pulseRing {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .speaking {
            animation: speaking 1s ease-in-out infinite alternate;
        }
        
        @keyframes speaking {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .mobile-container {
            width: 100%;
            max-width: 428px;
            margin: 0 auto;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 480px) {
            .mobile-container {
                max-width: 100%;
                padding: 0;
            }
            
            .card-modern {
                margin: 0 8px;
                border-radius: 16px;
            }
            
            .btn-primary, .btn-secondary {
                padding: 14px 20px;
                font-size: 15px;
                border-radius: 12px;
            }
            
            .age-btn {
                padding: 12px 8px !important;
                font-size: 14px;
            }
        }
        
        /* Dokunmatik cihazlar i√ßin */
        @media (hover: none) and (pointer: coarse) {
            .hover-lift:hover {
                transform: none;
            }
            
            .hover-lift:active {
                transform: translateY(-2px);
            }
            
            .btn-primary:active, .btn-secondary:active {
                transform: translateY(-1px);
            }
        }
        
        .adventure-bg {
            background: linear-gradient(135deg, theme('colors.primary') 0%, theme('colors.purple.500') 100%);
            position: relative;
            overflow: hidden;
        }
        
        .adventure-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="30" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #059669);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .level-badge {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .xp-counter {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Origami Diagrams (Re-added for consistency with previous version) */
        .origami-diagram-container {
            position: relative;
            width: 100%;
            max-width: 250px;
            height: 200px;
            margin-left: auto;
            margin-right: auto;
            border: 2px solid theme('colors.stori-text');
            background-color: theme('colors.white');
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-bottom: 1rem;
        }
        .origami-square {
            position: relative;
            width: 150px;
            height: 150px;
            background-color: theme('colors.stori-sky');
            border: 1px solid theme('colors.stori-lila');
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            transform-origin: center center;
        }
        .fold-line {
            position: absolute;
            background-color: theme('colors.stori-text');
            opacity: 0.6;
        }
        .fold-line.diagonal-1 {
            width: 100%; height: 1px;
            top: 50%; left: 0;
            transform: translateY(-50%) rotate(45deg);
            transform-origin: center;
        }
        .fold-line.diagonal-2 {
            width: 100%; height: 1px;
            top: 50%; left: 0;
            transform: translateY(-50%) rotate(-45deg);
            transform-origin: center;
        }
        .fold-line.horizontal {
            width: 100%; height: 1px;
            top: 50%; left: 0;
            transform: translateY(-50%);
        }
        .fold-line.vertical {
            width: 1px; height: 100%;
            top: 0; left: 50%;
            transform: translateX(-50%);
        }
        .folded-corner-sym {
            position: absolute;
            width: 50%; height: 50%;
            background-color: theme('colors.stori-mint');
            border: 1px solid #7E9989;
            transform-origin: center center;
            clip-path: polygon(0 0, 100% 0, 0 100%);
        }
        .folded-corner-sym.top-right {
            top: 0; right: 0;
            transform: rotate(90deg);
        }
        .folded-corner-sym.bottom-right {
            bottom: 0; right: 0;
            transform: rotate(180deg);
        }
        .folded-corner-sym.bottom-left {
            bottom: 0; left: 0;
            transform: rotate(270deg);
        }
        .arrow-indicator {
            position: absolute;
            font-size: 1.5rem;
            color: theme('colors.stori-orange');
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .arrow-indicator.top-left { top: 10%; left: 10%; }
        .arrow-indicator.top-right { top: 10%; right: 10%; }
        .arrow-indicator.bottom-left { bottom: 10%; left: 10%; }
        .arrow-indicator.bottom-right { bottom: 10%; right: 10%; }
        .arrow-indicator.center { top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .kite-base-shape {
            width: 120px;
            height: 120px;
            background-color: theme('colors.stori-sky');
            position: relative;
            clip-path: polygon(0 0, 100% 0, 50% 100%);
            border: 1px solid theme('colors.stori-lila');
        }
        .waterbomb-base-shape {
            width: 120px;
            height: 120px;
            background-color: theme('colors.stori-sky');
            position: relative;
            transform: rotate(45deg);
            border: 1px solid theme('colors.stori-lila');
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .bird-base-shape {
            width: 120px;
            height: 120px;
            background-color: theme('colors.stori-sky');
            position: relative;
            transform: rotate(45deg);
            border: 1px solid theme('colors.stori-lila');
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .bird-base-shape::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            top: 0; left: 0;
            background-color: theme('colors.stori-mint');
            clip-path: polygon(0 0, 100% 0, 50% 100%, 0 100%);
        }
        .triangle-flap-top {
            position: absolute;
            width: 0; height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 50px solid theme('colors.stori-mint');
            top: 0; left: 50%;
            transform: translateX(-50%);
        }
        .triangle-flap-bottom {
             position: absolute;
            width: 0; height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-top: 50px solid theme('colors.stori-mint');
            bottom: 0; left: 50%;
            transform: translateX(-50%);
        }

        .hat-shape {
            width: 150px;
            height: 100px;
            background-color: theme('colors.stori-sky');
            position: relative;
            border-radius: 8px 8px 0 0;
            border: 1px solid theme('colors.stori-lila');
        }
        .hat-shape::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 0; height: 0;
            border-left: 75px solid transparent;
            border-right: 75px solid transparent;
            border-bottom: 75px solid theme('colors.stori-mint');
            transform: translateY(-75px);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="mobile-container">
        <!-- Kar≈üƒ±lama Ekranƒ± (Merhaba ve Ya≈ü Se√ßimi) -->
        <div id="welcomeScreen" class="adventure-bg min-h-screen flex flex-col items-center justify-center p-6 text-white">
            <div class="text-center mb-8">
                <div class="w-32 h-32 bg-white/20 rounded-full flex items-center justify-center mb-8 mx-auto backdrop-blur-sm">
                    <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold mb-4">Storigami</h1>
                <p class="text-xl opacity-90 mb-8">Origami Macera D√ºnyasƒ±</p>
            </div>

            <div class="w-full max-w-sm card-modern p-6 text-gray-900 mb-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-3">Ka√ß Ya≈üƒ±ndasƒ±n?</h2>
                    <p class="text-gray-600">Sana √∂zel maceralar hazƒ±rlayalƒ±m!</p>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectChildAge('4-6')" id="age-btn-4-6" class="age-btn py-3 px-4 rounded-2xl bg-stori-lila/50 backdrop-blur-sm border border-stori-lila/30 text-stori-text hover:bg-stori-lila/70 smooth-transition">
                        4-6 üê£
                    </button>
                    <button onclick="selectChildAge('7-9')" id="age-btn-7-9" class="age-btn py-3 px-4 rounded-2xl bg-stori-orange/50 backdrop-blur-sm border border-stori-orange/30 text-stori-text hover:bg-stori-orange/70 smooth-transition">
                        7-9 üê∂
                    </button>
                    <button onclick="selectChildAge('10-12')" id="age-btn-10-12" class="age-btn py-3 px-4 rounded-2xl bg-stori-mint/50 backdrop-blur-sm border border-stori-mint/30 text-stori-text hover:bg-stori-mint/70 smooth-transition">
                        10-12 üêâ
                    </button>
                </div>
                <input type="text" id="childName" placeholder="Adƒ±nƒ± yaz..."
                        class="w-full px-4 py-3 mt-6 rounded-2xl bg-white/50 backdrop-blur-sm border border-gray-300 text-stori-text placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            
            <button id="startAdventureBtn" onclick="startChildAdventure()" disabled
                    class="w-full max-w-sm py-4 rounded-2xl bg-white/30 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed enabled:hover:bg-white/40 enabled:cursor-pointer smooth-transition btn-primary">
                Maceraya Ba≈üla! üöÄ
            </button>
        </div>

        <!-- Ana Oyun Ekranƒ± -->
        <div id="gameScreen" class="hidden min-h-screen bg-surface">
            <!-- Oyun Header'ƒ± -->
            <div class="bg-white shadow-sm p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center">
                            <span class="text-white font-bold text-sm" id="playerInitial">K</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900" id="playerName">Kahraman</h3>
                            <div class="flex items-center space-x-2">
                                <span class="level-badge" id="playerLevel">Seviye 1</span>
                                <span class="xp-counter" id="playerXP">0 XP</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="showSettings()" class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                        </svg>
                    </button>
                </div>
                
                <!-- ƒ∞lerleme √áubuƒüu -->
                <div class="mt-4">
                    <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                        <span>Macera ƒ∞lerlemesi</span>
                        <span id="progressText">0/10</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Macera Haritasƒ± -->
            <div class="p-4">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Origami Krallƒ±ƒüƒ±</h2>
                    <p class="text-gray-600">Hangi maceraya √ßƒ±kmak istiyorsun?</p>
                </div>

                <!-- Macera Kartlarƒ± -->
                <div class="space-y-4">
                    <!-- Kaƒüƒ±t Ormanƒ± -->
                    <div class="card-modern p-6 hover-lift smooth-transition" onclick="showAdventureDetail('forest')">
                        <div class="flex items-center">
                            <div class="w-16 h-16 gradient-accent rounded-2xl flex items-center justify-center mr-4">
                                <span class="text-3xl">üå≥</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900">Kaƒüƒ±t Ormanƒ±</h3>
                                <p class="text-gray-600 text-sm">Origami hayvanlarƒ±yla tanƒ±≈ü ve bilgi kartlarƒ±nƒ± ke≈üfet!</p>
                                <div class="flex items-center mt-2">
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Kolay</span>
                                    <span class="text-xs text-gray-500 ml-2">+50 XP</span>
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 ml-2 rounded-full">AI</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                                    <span class="text-gray-600">‚Üí</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hikaye Kalesi -->
                    <div class="card-modern p-6 hover-lift smooth-transition" onclick="showAdventureDetail('castle')">
                        <div class="flex items-center">
                            <div class="w-16 h-16 gradient-secondary rounded-2xl flex items-center justify-center mr-4">
                                <span class="text-3xl">üè∞</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900">Hikaye Kalesi</h3>
                                <p class="text-gray-600 text-sm">Origami fotoƒüraflarƒ±ndan yapay zeka ile hikaye olu≈ütur!</p>
                                <div class="flex items-center mt-2">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Orta</span>
                                    <span class="text-xs text-gray-500 ml-2">+100 XP</span>
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 ml-2 rounded-full">AI</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                                    <span class="text-gray-600">‚Üí</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Yaratƒ±cƒ±lƒ±k Adasƒ± -->
                    <div class="card-modern p-6 hover-lift smooth-transition" onclick="showAdventureDetail('island')">
                        <div class="flex items-center">
                            <div class="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center mr-4">
                                <span class="text-3xl">üèùÔ∏è</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900">Yaratƒ±cƒ±lƒ±k Adasƒ±</h3>
                                <p class="text-gray-600 text-sm">Origamilerine yaratƒ±cƒ± isimler bul!</p>
                                <div class="flex items-center mt-2">
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Zor</span>
                                    <span class="text-xs text-gray-500 ml-2">+150 XP</span>
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 ml-2 rounded-full">AI</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                                    <span class="text-gray-600">‚Üí</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- G√ºnl√ºk G√∂revler -->
                <div class="mt-8">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">G√ºnl√ºk G√∂revler</h3>
                    <div class="space-y-3">
                        <div class="card-modern p-4 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-lg">‚≠ê</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">Yeni bir origami fig√ºr√º yap</p>
                                    <p class="text-sm text-gray-500">+25 XP</p>
                                </div>
                            </div>
                            <button class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full">Tamamla</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Genel Geri D√∂n Butonu -->
            <div class="text-center mt-8 p-4">
                <button onclick="goBackToWelcome()" class="inline-flex items-center px-6 py-3 bg-gray-100 text-gray-700 rounded-2xl font-medium hover:bg-gray-200 smooth-transition">
                    <span class="mr-2">‚Üê</span> Ana Sayfaya D√∂n
                </button>
            </div>
        </div>

        <!-- Macera Detay Ekranlarƒ± (Mod√ºler ƒ∞√ßerik) -->
        <div id="adventureDetailScreenForest" class="hidden min-h-screen bg-surface px-6 py-12">
            <div class="max-w-xl mx-auto text-center">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6">Kaƒüƒ±t Ormanƒ± üå≥</h2>
                <p class="text-lg text-gray-600 mb-8">Hangi hayvanƒ± tanƒ±mak istersin?</p>
                
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <button onclick="generateAnimalFact('ku≈ü')" class="card-modern p-6 hover-lift">
                        <span class="text-5xl block mb-2">üê¶</span>
                        <span class="font-semibold text-gray-900">Ku≈ü</span>
                    </button>
                    <button onclick="generateAnimalFact('kurbaƒüa')" class="card-modern p-6 hover-lift">
                        <span class="text-5xl block mb-2">üê∏</span>
                        <span class="font-semibold text-gray-900">Kurbaƒüa</span>
                    </button>
                    <button onclick="generateAnimalFact('tilki')" class="card-modern p-6 hover-lift">
                        <span class="text-5xl block mb-2">ü¶ä</span>
                        <span class="font-semibold text-gray-900">Tilki</span>
                    </button>
                    <button onclick="generateAnimalFact('fil')" class="card-modern p-6 hover-lift">
                        <span class="text-5xl block mb-2">üêò</span>
                        <span class="font-semibold text-gray-900">Fil</span>
                    </button>
                </div>
                
                <div id="animalFactOutput" class="card-modern p-6 text-left min-h-[120px] flex items-center justify-center text-gray-800">
                    Bir hayvan se√ßerek bilgi kartƒ±nƒ± g√∂r!
                </div>

                <button onclick="goBackToGameScreen()" class="inline-flex items-center px-6 py-3 bg-gray-100 text-gray-700 rounded-2xl font-medium hover:bg-gray-200 smooth-transition mt-8">
                    <span class="mr-2">‚Üê</span> Maceralara Geri D√∂n
                </button>
            </div>
        </div>

        <div id="adventureDetailScreenCastle" class="hidden min-h-screen bg-surface px-6 py-12">
            <div class="max-w-2xl mx-auto">
                <div class="text-center mb-12">
                    <div class="w-16 h-16 gradient-secondary rounded-2xl flex items-center justify-center mb-6 mx-auto">
                        <span class="text-3xl text-white">üè∞</span>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                        Hikaye Kalesi
                    </h2>
                    <p class="text-lg text-gray-600">Origami fotoƒürafƒ±nƒ± y√ºkle, AI hikaye sihri ba≈ülasƒ±n!</p>
                </div>

                <div class="card-modern p-8 mb-8">
                    <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-3xl p-12 text-center smooth-transition hover:border-primary hover:bg-primary/5">
                        <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mb-6 mx-auto">
                            <svg class="w-8 h-8 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Fotoƒüraf Se√ß</h3>
                        <p class="text-gray-600 mb-6">Origami √ßalƒ±≈ümanƒ±n fotoƒürafƒ±nƒ± y√ºkle</p>
                        <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                        <button onclick="document.getElementById('photoInput').click()" class="btn-primary">
                            Dosya Se√ß
                        </button>
                    </div>

                    <div id="uploadedPhoto" class="hidden">
                        <div class="relative mb-6">
                            <img id="photoPreview" class="w-full rounded-2xl shadow-lg">
                            <button onclick="removePhoto()" class="absolute top-4 right-4 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 smooth-transition">
                                √ó
                            </button>
                        </div>
                        <button id="analyzeBtn" onclick="analyzePhoto()" class="btn-secondary w-full flex items-center justify-center">
                            <span id="analyzeBtnText" class="mr-2">ü§ñ</span> <span id="analyzeBtnSpinner" class="loading-spinner hidden ml-2"></span> AI Hikaye Olu≈ütur
                        </button>
                    </div>

                    <div id="storyResultDisplay" class="mt-8 hidden">
                        <h3 class="text-xl font-bold text-center text-gray-900 mb-4">Hik√¢yen Hazƒ±r!</h3>
                        <div class="bg-gradient-to-br from-primary/5 to-secondary/5 rounded-2xl p-6 mb-6">
                            <p id="storyText" class="text-lg text-gray-800 leading-relaxed">
                                <!-- Hikaye buraya gelecek -->
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="playStoryBtn" class="flex-1 btn-primary flex items-center justify-center">
                                <span class="mr-2">üîä</span> Sesli Dinle
                                <span id="playStorySpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <button onclick="changeStory()" class="flex-1 bg-gray-100 text-gray-700 px-6 py-4 rounded-2xl font-semibold hover:bg-gray-200 smooth-transition">
                                <span class="mr-2">üîÑ</span> Yeni Hikaye
                            </button>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <button onclick="goBackToGameScreen()" class="inline-flex items-center px-6 py-3 bg-gray-100 text-gray-700 rounded-2xl font-medium hover:bg-gray-200 smooth-transition">
                        <span class="mr-2">‚Üê</span> Maceralara Geri D√∂n
                    </button>
                </div>
            </div>
        </div>

        <div id="adventureDetailScreenIsland" class="hidden min-h-screen bg-surface px-6 py-12">
            <div class="max-w-xl mx-auto text-center">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6">Yaratƒ±cƒ±lƒ±k Adasƒ± üèùÔ∏è</h2>
                <p class="text-lg text-gray-600 mb-8">Origaminin neye benzediƒüini anlat, yapay zeka sana yaratƒ±cƒ± isimler √∂nerir!</p>

                <div class="card-modern p-8 smooth-transition text-left">
                    <input type="text" id="origamiNameInput" placeholder="Origamin neye benziyor? (√∂rn: zƒ±playan kurbaƒüa, √ßi√ßek)" class="mt-4 w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="generateNamesBtn" onclick="generateOrigamiNames()" class="btn-primary w-full mt-4 flex items-center justify-center">
                        <span id="generateNamesBtnText" class="mr-2">ƒ∞sim √ñner ‚ú®</span>
                        <span id="nameLoadingSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    <div id="nameSuggestionsOutput" class="mt-6 p-4 bg-surface-dark rounded-xl min-h-[80px] text-gray-800 flex items-center justify-center">
                        √ñnerilen isimler burada g√∂r√ºnecek...
                    </div>
                </div>

                <button onclick="goBackToGameScreen()" class="inline-flex items-center px-6 py-3 bg-gray-100 text-gray-700 rounded-2xl font-medium hover:bg-gray-200 smooth-transition mt-8">
                    <span class="mr-2">‚Üê</span> Maceralara Geri D√∂n
                </button>
            </div>
        </div>

        <!-- Sesli Asistan -->
        <div class="floating-voice">
            <div class="relative">
                <div class="absolute inset-0 bg-primary rounded-full pulse-ring" id="voiceRing"></div>
                <button onclick="toggleVoice()" id="voiceBtn" class="relative w-14 h-14 gradient-primary rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 smooth-transition">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Oyun durumu
        let gameState = {
            playerName: '',
            playerAge: '',
            playerLevel: 1,
            playerXP: 0,
            progress: 0,
            voiceEnabled: true,
            currentScreen: 'welcome'
        };

        // LLM ile konu≈üma i√ßin gerekli helpers (Base64 to ArrayBuffer ve PCM to WAV)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const dataLength = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');

            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, 1, true); // 1 channel
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // byte rate (sampleRate * numChannels * bytesPerSample)
            view.setUint16(32, 2, true); // block align (numChannels * bytesPerSample)
            view.setUint16(34, 16, true); // bits per sample

            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // T√ºm ekranlarƒ± gizle ve yeni ekranƒ± g√∂ster
        function showScreen(screenId) {
            const screens = ['welcomeScreen', 'gameScreen', 'adventureDetailScreenForest', 'adventureDetailScreenCastle', 'adventureDetailScreenIsland'];
            screens.forEach(id => {
                const screen = document.getElementById(id);
                if (screen) {
                    screen.classList.add('hidden');
                    screen.classList.remove('fade-in', 'slide-in-right');
                }
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('fade-in');
            }
            gameState.currentScreen = screenId;
        }

        // Ses efektleri
        function playClickSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                console.log('Ses efekti √ßalƒ±namadƒ±:', error);
            }
        }
        
        function playHoverSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(700, audioContext.currentTime + 0.05);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.05);
            } catch (error) {
                console.log('Hover ses efekti √ßalƒ±namadƒ±:', error);
            }
        }

        // Ya≈ü se√ßimi
        function selectChildAge(age) {
            playClickSound();
            gameState.playerAge = age;
            document.querySelectorAll('.age-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-primary', 'bg-stori-lila/70', 'bg-stori-orange/70', 'bg-stori-mint/70');
                btn.classList.add('bg-stori-lila/50', 'bg-stori-orange/50', 'bg-stori-mint/50'); // Re-apply base transparency
            });
            const clickedBtn = document.getElementById(`age-btn-${age.replace('-', '')}`);
            if (clickedBtn) {
                clickedBtn.classList.add('ring-2', 'ring-primary');
                // Ensure the specific color for the button is maintained but highlight added
                if (age === '4-6') clickedBtn.classList.replace('bg-stori-lila/50', 'bg-stori-lila/70');
                if (age === '7-9') clickedBtn.classList.replace('bg-stori-orange/50', 'bg-stori-orange/70');
                if (age === '10-12') clickedBtn.classList.replace('bg-stori-mint/50', 'bg-stori-mint/70');
            }
            checkChildLoginForm();
            if (gameState.voiceEnabled) {
                playTextToSpeech(`${age} ya≈ü grubu se√ßildi! Harika se√ßim!`);
            }
        }

        // √áocuk giri≈ü formu kontrol√º
        function checkChildLoginForm() {
            const nameInput = document.getElementById('childName');
            const startBtn = document.getElementById('startAdventureBtn');
            const name = nameInput.value.trim();
            if (name.length >= 2 && gameState.playerAge) {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // √áocuk macerasƒ±nƒ± ba≈ülat
        async function startChildAdventure() {
            playClickSound();
            const nameInput = document.getElementById('childName');
            const name = nameInput.value.trim();
            if (!name || name.length < 2) {
                showNotification('L√ºtfen en az 2 harfli bir isim yaz!');
                return false;
            }
            if (!gameState.playerAge) {
                showNotification('L√ºtfen ya≈ü grubunu se√ß!');
                return false;
            }
            gameState.playerName = name;
            document.getElementById('playerName').textContent = name;
            document.getElementById('playerInitial').textContent = name.charAt(0).toUpperCase();
            showScreen('gameScreen');
            updateGameUI();
            if (gameState.voiceEnabled) {
                await playTextToSpeech(`Ho≈ü geldin ${name}! Origami krallƒ±ƒüƒ±na maceraya hazƒ±r mƒ±sƒ±n?`);
            }
            return true;
        }

        // Macera ekranƒ±na geri d√∂n
        function goBackToGameScreen() {
            playClickSound();
            showScreen('gameScreen');
            // Reset any specific detail screen states if needed
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreview').src = '';
            document.getElementById('uploadedPhoto').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('storyResultDisplay').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('origamiNameInput').value = '';
            document.getElementById('nameSuggestionsOutput').innerHTML = '√ñnerilen isimler burada g√∂r√ºnecek...';
            if (currentStoryAudio) {
                currentStoryAudio.pause();
                currentStoryAudio.currentTime = 0;
                URL.revokeObjectURL(currentStoryAudio.src);
                currentStoryAudio = null;
            }
        }

        // Ana kar≈üƒ±lama ekranƒ±na d√∂n
        function goBackToWelcome() {
            playClickSound();
            showScreen('welcomeScreen');
            gameState.playerName = '';
            gameState.playerAge = '';
            gameState.playerLevel = 1;
            gameState.playerXP = 0;
            gameState.progress = 0;
            document.getElementById('selectedAge').textContent = 'Se√ßilmedi';
            document.getElementById('childName').value = '';
            document.querySelectorAll('.age-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-primary', 'bg-stori-lila/70', 'bg-stori-orange/70', 'bg-stori-mint/70');
                btn.classList.add('bg-stori-lila/50', 'bg-stori-orange/50', 'bg-stori-mint/50');
            });
            document.getElementById('startAdventureBtn').disabled = true;
            if (currentStoryAudio) {
                currentStoryAudio.pause();
                currentStoryAudio.currentTime = 0;
                URL.revokeObjectURL(currentStoryAudio.src);
                currentStoryAudio = null;
            }
        }

        // Macera detay ekranlarƒ±nƒ± g√∂ster
        function showAdventureDetail(type) {
            playClickSound();
            if (type === 'forest') {
                showScreen('adventureDetailScreenForest');
                if (gameState.voiceEnabled) {
                    playTextToSpeech("Kaƒüƒ±t Ormanƒ±'na ho≈ü geldin! Hangi hayvanƒ± tanƒ±mak istersin?");
                }
            } else if (type === 'castle') {
                showScreen('adventureDetailScreenCastle');
                if (gameState.voiceEnabled) {
                    playTextToSpeech("Hikaye Kalesi'ne ho≈ü geldin! Origami fotoƒürafƒ±nƒ± y√ºkle, sana bir hikaye anlatayƒ±m!");
                }
            } else if (type === 'island') {
                showScreen('adventureDetailScreenIsland');
                if (gameState.voiceEnabled) {
                    playTextToSpeech("Yaratƒ±cƒ±lƒ±k Adasƒ±'na ho≈ü geldin! Origamin i√ßin yaratƒ±cƒ± isimler bulalƒ±m!");
                }
            }
            // Simulate XP gain for entering an adventure
            gainXP(25);
        }

        // XP kazanƒ±mƒ±
        function gainXP(amount) {
            gameState.playerXP += amount;
            gameState.progress = Math.min(gameState.progress + 1, 10);
            
            const newLevel = Math.floor(gameState.playerXP / 200) + 1;
            if (newLevel > gameState.playerLevel) {
                gameState.playerLevel = newLevel;
                if (gameState.voiceEnabled) {
                    playTextToSpeech(`Tebrikler! Seviye ${newLevel} oldun!`);
                }
            }
            updateGameUI();
            if (gameState.voiceEnabled) {
                playTextToSpeech(`${amount} deneyim puanƒ± kazandƒ±n!`);
            }
        }

        // Oyun UI g√ºncelleme
        function updateGameUI() {
            document.getElementById('playerLevel').textContent = `Seviye ${gameState.playerLevel}`;
            document.getElementById('playerXP').textContent = `${gameState.playerXP} XP`;
            document.getElementById('progressText').textContent = `${gameState.progress}/10`;
            document.getElementById('progressFill').style.width = `${(gameState.progress / 10) * 100}%`;
        }

        let currentStoryAudio = null; // Store the Audio object for story playback

        // Metinden konu≈ümaya (Gemini TTS)
        async function playTextToSpeech(text) {
            if (!gameState.voiceEnabled) return;

            const voiceBtn = document.getElementById('voiceBtn');
            const voiceRing = document.getElementById('voiceRing');
            
            voiceBtn.classList.add('speaking');
            if (voiceRing) voiceRing.style.display = 'block';

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Zephyr" } } // √áocuklar i√ßin uygun bir ses
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const part = result.candidates[0].content.parts[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;

                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        
                        if (currentStoryAudio) {
                            currentStoryAudio.pause();
                            URL.revokeObjectURL(currentStoryAudio.src);
                        }
                        currentStoryAudio = new Audio(URL.createObjectURL(wavBlob));
                        await currentStoryAudio.play();
                    } else {
                        console.error('TTS audio data missing or malformed.');
                    }
                } else {
                    console.error('TTS API response is not as expected.');
                }
            } catch (error) {
                console.error('Error in playTextToSpeech:', error);
            } finally {
                voiceBtn.classList.remove('speaking');
                if (voiceRing) voiceRing.style.display = 'none';
            }
        }

        // Ses a√ßma/kapama
        function toggleVoice() {
            gameState.voiceEnabled = !gameState.voiceEnabled;
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceRing = document.getElementById('voiceRing');
            
            if (gameState.voiceEnabled) {
                voiceBtn.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/></svg>`;
                playTextToSpeech("Sesli asistan a√ßƒ±ldƒ±!");
            } else {
                if (currentStoryAudio) {
                    currentStoryAudio.pause();
                    currentStoryAudio.currentTime = 0;
                }
                voiceBtn.classList.remove('speaking');
                if (voiceRing) voiceRing.style.display = 'none';
                voiceBtn.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19M16.5,12C16.5,12 17.5,10.5 17.5,10.5L19,12L17.5,13.5C17.5,13.5 16.5,12 16.5,12Z"/></svg>`;
            }
        }

        // Ayarlar (placeholder)
        function showSettings() {
            showNotification('Ayarlar men√ºs√º geli≈ütirme a≈üamasƒ±nda!');
        }

        // Metin bildirimleri
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-6 right-6 bg-primary text-white px-6 py-3 rounded-2xl shadow-lg z-50 max-w-sm';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // API √ßaƒürƒ±larƒ± i√ßin retry mekanizmasƒ±
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        console.warn(`Too many requests, retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Fetch failed, retrying in ${delay / 1000}s...`, error);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        // Kaƒüƒ±t Ormanƒ± - Hayvan Bilgisi √úretimi
        async function generateAnimalFact(animalType) {
            document.getElementById('animalFactOutput').innerHTML = '<p class="text-gray-500 text-center">Bilgi kartƒ± olu≈üturuluyor...</p>';
            
            const prompt = `"${gameState.playerAge}" ya≈ü grubu i√ßin "${animalType}" hakkƒ±nda eƒülenceli ve kƒ±sa bir bilgi veya konu≈üma balonu olu≈ütur. Maksimum 30 kelime.`;
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "text/plain" // Basit metin yanƒ±tƒ± bekliyoruz
                }
            };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const fact = result.candidates[0].content.parts[0].text;
                    document.getElementById('animalFactOutput').innerHTML = `<p class="text-lg font-semibold">${fact}</p>`;
                    if (gameState.voiceEnabled) {
                        playTextToSpeech(fact);
                    }
                } else {
                    document.getElementById('animalFactOutput').innerHTML = '<p class="text-red-500 text-center">Bilgi alƒ±namadƒ±. Tekrar deneyin.</p>';
                }
            } catch (error) {
                console.error('Error generating animal fact:', error);
                document.getElementById('animalFactOutput').innerHTML = '<p class="text-red-500 text-center">Bir hata olu≈ütu. L√ºtfen tekrar deneyin.</p>';
            }
        }

        // Hikaye Kalesi - Fotoƒüraf Y√ºkleme ve AI Hikaye √úretimi
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').src = e.target.result;
                    document.getElementById('uploadedPhoto').classList.remove('hidden');
                    document.getElementById('uploadArea').classList.add('hidden');
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('analyzeBtn').querySelector('#analyzeBtnText').textContent = 'ü§ñ';
                    document.getElementById('analyzeBtn').querySelector('.loading-spinner').classList.add('hidden');
                    document.getElementById('storyResultDisplay').classList.add('hidden'); // Gizle
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            document.getElementById('uploadedPhoto').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreview').src = '';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('storyResultDisplay').classList.add('hidden');
            if (currentStoryAudio) {
                currentStoryAudio.pause();
                currentStoryAudio.currentTime = 0;
                URL.revokeObjectURL(currentStoryAudio.src);
                currentStoryAudio = null;
            }
        }

        async function analyzePhoto() {
            const photoPreview = document.getElementById('photoPreview');
            const base64Image = photoPreview.src;

            if (!base64Image || base64Image.startsWith('data:,')) {
                showNotification('L√ºtfen √∂nce bir fotoƒüraf y√ºkleyin.');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const analyzeBtnText = document.getElementById('analyzeBtnText');
            const analyzeBtnSpinner = analyzeBtn.querySelector('.loading-spinner');

            analyzeBtnText.textContent = 'AI Analiz Ediyor';
            analyzeBtnSpinner.classList.remove('hidden');
            analyzeBtn.disabled = true;
            document.getElementById('storyText').textContent = 'Hik√¢ye olu≈üturuluyor, l√ºtfen bekleyin...';
            document.getElementById('playStoryBtn').disabled = true;

            const base64Data = base64Image.split(',')[1];
            
            let chatHistory = [];
            const prompt = `Bu origami fig√ºr√º hakkƒ±nda "${gameState.playerAge}" ya≈ü grubuna uygun, ne≈üeli ve maceracƒ± bir hikaye yaz. Hikayenin ba≈ülƒ±ƒüƒ±nƒ± ve i√ßeriƒüini JSON formatƒ±nda verin. Ba≈ülƒ±k ve hikaye toplam 100 kelimeyi ge√ßmesin.`;
            chatHistory.push({ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: photoPreview.src.split(':')[1].split(';')[0], data: base64Data } }] });

            const textPayload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "title": { "type": "STRING" },
                            "story": { "type": "STRING" }
                        },
                        "propertyOrdering": ["title", "story"]
                    }
                }
            };
            const apiKey = "";
            const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const textResponse = await fetchWithRetry(textApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(textPayload)
                });
                const textResult = await textResponse.json();

                let storyTitle = 'Bir Hikaye';
                let storyTextContent = 'Hikaye olu≈üturulamadƒ±. L√ºtfen tekrar deneyin.';

                if (textResult.candidates && textResult.candidates.length > 0 &&
                    textResult.candidates[0].content && textResult.candidates[0].content.parts &&
                    textResult.candidates[0].content.parts.length > 0) {
                    try {
                        const jsonString = textResult.candidates[0].content.parts[0].text;
                        const parsedStory = JSON.parse(jsonString);
                        storyTitle = parsedStory.title || 'Bir Hikaye';
                        storyTextContent = parsedStory.story || 'Hikaye olu≈üturulamadƒ±. L√ºtfen tekrar deneyin.';
                    } catch (e) {
                        console.error("Failed to parse story JSON:", e);
                        storyTextContent = "Hikaye formatƒ± beklenenden farklƒ±. L√ºtfen tekrar deneyin.";
                    }
                }

                document.getElementById('storyText').innerHTML = `<strong class="text-primary">${storyTitle}</strong><br>${storyTextContent}`;
                document.getElementById('storyResultDisplay').classList.remove('hidden');

                // Generate TTS audio
                document.getElementById('playStoryBtn').disabled = true; // Disable until audio ready
                await playTextToSpeech(storyTextContent); // Use shared TTS function
                document.getElementById('playStoryBtn').disabled = false;
                showNotification('üîä Hikaye sesli olarak hazƒ±r!');

            } catch (error) {
                console.error('Error during story generation or TTS:', error);
                document.getElementById('storyText').textContent = 'Hikaye olu≈üturulurken bir hata olu≈ütu. L√ºtfen tekrar deneyin.';
                showNotification('Bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.');
                document.getElementById('playStoryBtn').disabled = true;
            } finally {
                analyzeBtnText.textContent = 'ü§ñ';
                analyzeBtnSpinner.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        function playStory() {
            if (currentStoryAudio) {
                currentStoryAudio.play();
                showNotification('üîä Hikaye sesli olarak oynatƒ±lƒ±yor...');
            } else {
                showNotification('Sesli hikaye hazƒ±r deƒüil. L√ºtfen √∂nce hikaye olu≈üturun.');
            }
        }

        async function changeStory() {
            showNotification('Yeni bir hikaye olu≈üturuluyor...');
            await analyzePhoto(); // Re-use analyzePhoto logic to get a new story
        }

        // Yaratƒ±cƒ±lƒ±k Adasƒ± - ƒ∞sim √úretimi
        async function generateOrigamiNames() {
            const origamiDescription = document.getElementById('origamiNameInput').value.trim();
            const generateNamesBtn = document.getElementById('generateNamesBtn');
            const generateNamesBtnText = document.getElementById('generateNamesBtnText');
            const nameLoadingSpinner = generateNamesBtn.querySelector('.loading-spinner');
            const nameSuggestionsOutput = document.getElementById('nameSuggestionsOutput');

            if (!origamiDescription) {
                nameSuggestionsOutput.innerHTML = '<p class="text-red-500 text-center">L√ºtfen origaminizi tanƒ±mlayƒ±n.</p>';
                return;
            }

            generateNamesBtnText.textContent = '√ñneri Olu≈üturuluyor';
            nameLoadingSpinner.classList.remove('hidden');
            generateNamesBtn.disabled = true;
            nameSuggestionsOutput.innerHTML = '<p class="text-gray-500 text-center">Yaratƒ±cƒ± isimler aranƒ±yor...</p>';

            let chatHistory = [];
            const prompt = `"${gameState.playerAge}" ya≈ü grubuna uygun, "${origamiDescription}" temalƒ± bir origami fig√ºr√º i√ßin 5 yaratƒ±cƒ± isim √∂nerisi sun. ƒ∞simler eƒülenceli ve akƒ±lda kalƒ±cƒ± olsun. Yanƒ±tƒ± JSON formatƒ±nda (bir dizi string olarak) ver. √ñrnek: ["ƒ∞sim1", "ƒ∞sim2", "ƒ∞sim3"]`;
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { "type": "STRING" }
                    }
                }
            };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const json = result.candidates[0].content.parts[0].text;
                    const parsedNames = JSON.parse(json);
                    displayOrigamiNames(parsedNames);
                    if (gameState.voiceEnabled) {
                        playTextToSpeech("ƒ∞≈üte origamin i√ßin harika isim √∂nerileri: " + parsedNames.join(", "));
                    }
                } else {
                    nameSuggestionsOutput.innerHTML = '<p class="text-red-500 text-center">ƒ∞sim √∂nerisi alƒ±namadƒ±. L√ºtfen tekrar deneyin.</p>';
                }
            } catch (error) {
                console.error('Error fetching AI name suggestions:', error);
                nameSuggestionsOutput.innerHTML = '<p class="text-red-500 text-center">Bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.</p>';
            } finally {
                generateNamesBtnText.textContent = 'ƒ∞sim √ñner ‚ú®';
                nameLoadingSpinner.classList.add('hidden');
                generateNamesBtn.disabled = false;
            }
        }

        function displayOrigamiNames(names) {
            if (names.length === 0) {
                nameSuggestionsOutput.innerHTML = '<p class="text-gray-500 text-center">Herhangi bir isim √∂nerisi bulunamadƒ±.</p>';
                return;
            }
            let html = '<ul class="list-disc list-inside space-y-2 text-left">';
            names.forEach(name => {
                html += `<li class="text-gray-800"><span class="font-semibold text-primary">"${name}"</span></li>`;
            });
            html += '</ul>';
            nameSuggestionsOutput.innerHTML = html;
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            showScreen('welcomeScreen');
            
            // Ya≈ü ve isim inputu i√ßin event listener'lar
            document.getElementById('childName').addEventListener('input', checkChildLoginForm);
            document.getElementById('childName').addEventListener('keyup', checkChildLoginForm);

            // T√ºm butonlara hover ve click ses efektleri ekle
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    if (!this.disabled && gameState.voiceEnabled) {
                        playHoverSound();
                    }
                });
                btn.addEventListener('click', function() {
                    if (!this.disabled) { // Click sound is handled by specific functions
                        // playClickSound();
                    }
                });
            });
            
            // Ba≈ülangƒ±√ß sesi
            setTimeout(() => {
                if (gameState.voiceEnabled) {
                    playTextToSpeech("Storigami Origami Macera D√ºnyasƒ±na ho≈ü geldin! L√ºtfen adƒ±nƒ± ve ya≈üƒ±nƒ± se√ßerek maceraya ba≈üla.");
                }
            }, 1500);
        });
    </script>
</body>
</html>
